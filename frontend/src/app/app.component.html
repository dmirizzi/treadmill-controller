<div class="app-root" [class.app-root--dark]="themeMode === 'dark'">
  <!-- Transient overlay banner -->
  <div 
    class="banner-container" 
    *ngIf="bannerVisible"
    [@bannerAnim]>
    <div
      class="banner-inner"
      [class.banner-inner--error]="bannerType === 'error'">
      <span class="banner-icon" *ngIf="bannerType === 'error'">!</span>
      <span class="banner-text">{{ bannerMessage }}</span>
    </div>
  </div>

  <!-- Top bar -->
  <header class="app-header">
    <div class="title-group">
      <div class="app-title">{{ title }}</div>
      <div class="subtitle">Home treadmill</div>
    </div>

    <div class="header-controls">
      <button
        type="button"
        class="theme-toggle"
        (click)="toggleTheme()"
        [attr.aria-label]="themeMode === 'light' ? 'Switch to dark mode' : 'Switch to light mode'">
        <div class="theme-toggle-track">
          <div
            class="theme-toggle-knob"
            [class.theme-toggle-knob--dark]="themeMode === 'dark'">
            <span class="theme-toggle-icon" *ngIf="themeMode === 'light'">☾</span>
            <span class="theme-toggle-icon" *ngIf="themeMode === 'dark'">☼</span>
          </div>
        </div>
      </button>

      <button
        class="chip-button"
        [class.chip--connected]="isConnected"
        [disabled]="isConnecting || isConnected"
        (click)="onConnect()">
        <span class="chip-dot" *ngIf="isConnected"></span>
        <span *ngIf="isConnected">Connected</span>
        <span *ngIf="!isConnected && !isConnecting">Connect</span>
        <span *ngIf="isConnecting">Connecting…</span>
      </button>
    </div>
  </header>

  <div class="mode-switch">
    <button
      class="mode-pill"
      [class.mode-pill--active]="viewMode === 'manual'"
      (click)="viewMode = 'manual'">
      Manual
    </button>

    <button
      class="mode-pill"
      [class.mode-pill--active]="viewMode === 'hiit'"
      (click)="viewMode = 'hiit'">
      HIIT
    </button>
  </div>

  <!-- Content when we have status -->
  <main class="app-main" *ngIf="status as s; else emptyState">
    <ng-container [ngSwitch]="viewMode">

      <!-----------------------------------
        Manual control view
      ------------------------------------->
      <ng-container *ngSwitchCase="'manual'">
        <!-- Primary card: speed + start/stop -->
        <section class="card card--primary">
          <div class="card-header">
            <div class="card-title">Current speed</div>
            <div class="status-pills">
              <span
                class="pill"
                [class.pill--on]="isRunning">
                {{ isRunning ? 'Running' : 'Stopped' }}
              </span>
            </div>
          </div>

          <div class="speed-display">
            <span class="speed-value">
              {{ s.currentSpeedKmh | number:'1.1-1' }}
            </span>
            <span class="speed-unit">km/h</span>
          </div>

          <div class="primary-actions">
            <button
              class="btn btn--primary"
              (click)="onStart()"
              [disabled]="!isConnected || isRunning || isSendingCommand">
              Start
            </button>

            <button
              class="btn btn--secondary"
              (click)="onStop()"
              [disabled]="!isConnected || !isRunning || isSendingCommand">
              Stop
            </button>
          </div>

          <div class="connection-note" *ngIf="!isConnected">
            Connect your treadmill to control speed and see live stats.
          </div>
        </section>

        <!-- Target speed card -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Target speed</div>
            <div class="range-label">
              {{ s.minSpeedKmh | number:'1.1-1' }} – {{ s.maxSpeedKmh | number:'1.1-1' }} km/h
            </div>
          </div>

          <div class="target-speed-input">
            <div class="numeric-input">
              <input
                type="number"
                [(ngModel)]="speedInput"
                [min]="s.minSpeedKmh"
                [max]="s.maxSpeedKmh"
                step="0.1"
                [disabled]="!isConnected" />
              <span class="unit">km/h</span>
            </div>

            <div class="speed-shortcuts">
              <button
                *ngFor="let preset of [3, 3.5, 4, 5, 6]"
                type="button"
                class="chip-button speed-shortcut"
                (click)="onShortcutSpeed(preset)"
                [disabled]="!isConnected || isSendingCommand">
                {{ preset }} km/h
              </button>
            </div>

            <input
              type="range"
              [(ngModel)]="speedInput"
              [min]="s.minSpeedKmh"
              [max]="s.maxSpeedKmh"
              step="0.1"
              [disabled]="!isConnected" />

            <button
              class="btn btn--fullwidth"
              (click)="onSetSpeed()"
              [disabled]="!isConnected || isSendingCommand">
              Set speed
            </button>

            <div class="primary-actions inc-dec-speed-buttons">
              <button
                class="btn btn--primary"
                (click)="onChangeSpeed(0.1)"
                [disabled]="!isConnected || !isRunning || isSendingCommand">
                Increase Speed
              </button>

              <button
                class="btn btn--secondary"
                (click)="onChangeSpeed(-0.1)"
                [disabled]="!isConnected || !isRunning || isSendingCommand">
                Decrease Speed
              </button>
            </div>
          </div>
        </section>

      </ng-container>

      <!-----------------------------------
        HIIT control view
      ------------------------------------->
      <ng-container *ngSwitchCase="'hiit'">

        <!-- Primary card: HIIT workout control -->
        <section class="card card--primary hiit-card">
          <div class="card-header">
            <div class="card-title">HIIT workout</div>
            <span class="pill" [class.pill--on]="isHiitRunning">
              {{ currentPhaseLabel }} <!-- e.g. 'Warmup', 'High', 'Recover' -->
            </span>
          </div>

          <div class="hiit-timer">
            <div class="hiit-time">{{ formatTime(hiitRemainingSeconds) }}</div>
            <div class="hiit-subtime">
              {{ hiitCurrentIndex + 1 }} / {{ hiitTotalSegments }} segments
            </div>
          </div>

          <div class="hiit-speeds">
            <div class="hiit-row">
              <span class="hiit-label">Current target</span>
              <span class="hiit-value">{{ hiitCurrentSpeedKmh | number:'1.1-1' }} km/h</span>
            </div>
            <div class="hiit-row" *ngIf="hiitNextSpeedKmh != null">
              <span class="hiit-label">Next</span>
              <span class="hiit-value">{{ hiitNextSpeedKmh | number:'1.1-1' }} km/h</span>
            </div>
          </div>

          <div class="primary-actions">
            <button
              class="btn btn--primary"
              (click)="onHiitStart()"
              [disabled]="!isConnected || isHiitRunning || isSendingCommand">
              Start HIIT
            </button>

            <button
              class="btn btn--secondary"
              (click)="onHiitStop()"
              [disabled]="!isConnected || !isHiitRunning || isSendingCommand">
              Stop
            </button>
          </div>
        </section>

        <!-- HIIT presets card -->
        <section class="card hiit-card hiit-card--plans">
          <div class="card-header">
            <div class="card-title">HIIT plans</div>
          </div>

          <div class="hiit-presets">
            <button
              class="chip-button hiit-chip"
              [class.hiit-chip--active]="selectedHiitPreset === 'beginner'"
              (click)="selectHiitPreset('beginner')">
              Beginner · 10 min
            </button>

            <button
              class="chip-button hiit-chip"
              [class.hiit-chip--active]="selectedHiitPreset === 'classic'"
              (click)="selectHiitPreset('classic')">
              6×(1 min high / 1 min easy)
            </button>

            <button
              class="chip-button hiit-chip"
              [class.hiit-chip--active]="selectedHiitPreset === 'custom'"
              (click)="selectHiitPreset('custom')">
              Custom
            </button>
          </div>

          <div class="hiit-description">
            {{ hiitDescription }}
          </div>
        </section>

      </ng-container>
    </ng-container>

    <!-- Metrics grid -->
    <section class="metrics-grid">
      <article class="metric-card">
        <div class="metric-label">Time</div>
        <div class="metric-value">{{ formatTime(s.elapsedTimeSeconds) }}</div>
      </article>

      <article class="metric-card">
        <div class="metric-label">Distance</div>
        <div class="metric-value">
          {{ s.totalDistanceKm | number:'1.2-2' }}
          <span class="metric-unit">km</span>
        </div>
      </article>

      <article class="metric-card">
        <div class="metric-label">Calories</div>
        <div class="metric-value">
          {{ s.burnedCalories | number:'1.0-0' }}
          <span class="metric-unit">kcal</span>
        </div>
      </article>

      <article class="metric-card metric-card--muted">
        <div class="metric-label">Speed range</div>
        <div class="metric-value">
          {{ s.minSpeedKmh | number:'1.1-1' }} – {{ s.maxSpeedKmh | number:'1.1-1' }}
          <span class="metric-unit">km/h</span>
        </div>
      </article>
    </section>    
  </main>

  <!-- Empty / not yet connected state -->
  <ng-template #emptyState>
    <main class="app-main app-main--empty">
      <div class="empty-card">
        <div class="empty-title">Ready when you are</div>
        <p class="empty-text">
          Turn on your treadmill and tap <strong>Connect</strong>
          to get live speed, distance, calories and more.
        </p>
      </div>
    </main>
  </ng-template>
</div>
